<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8" />
  <title></title>
  <link type="text/css" href="style.css" rel="stylesheet">
</head>

<body onLoad="onLoad();">
  <form action="." method="get" onsubmit="return submitForm();">
    <table>
      <tr>
        <th>Step</th>
        <th>Description</th>
        <th>Detail</th>
      </tr>
      <tr>
        <td>1</td>
        <td>Create a private key and derive a camo public key</td>
        <td>
          Private Key:<br>
          <input id="private_key" name="private_key" value="" size="64" type="text">
          <p>
            <input value="New Random Private Key" type="button" onclick='return getNewPrivateKey();'>
          </p>
          <p>
            Banano Account:<br>
            <input id="banano_account" name="banano_account" value="" size="64" type="text">
            <br>
            <br>
            Camo Account:<br>
            <input id="camo_account" name="camo_account" value="" size="64" type="text">
          </p>
          <p><input value="Derive Camo And Banano Addresses" type="submit">
          </p>
        </td>
      </tr>
      <tr>
        <td>1</td>
        <td>Create a shared secret from (your) private key and somebody else's camo account</td>
        <td>
          (Somebody Else's) Camo Account <br>
          (From their rep field on their banano account):<br>
          <input id="other_camo_account" name="other_camo_account" value="" size="64" type="text">
          </p>
          <p><input value="Derive Shared Secret" type="button" onclick='return getNewSharedSecret();'>
          </p>
        </td>
      </tr>
    </table>
  </form>
  <script src='camo.js'></script>
  <!--
  <script src='https://coranos.github.io/js-lib/nacl.js'></script>
-->
  <script src='../../js-lib/nacl.js'></script>
  <script src='../../js-lib/blake2b.js'></script>
  <script src='../../js-lib/banano.js'></script>
  <script>
    const hexToBytes = (hex) => {
      const ret = new Uint8Array(hex.length / 2);
      for (var i = 0; i < ret.length; i++) {
        ret[i] = parseInt(hex.substring(i * 2, i * 2 + 2), 16);
      }
      return ret;
    }

    const bytesToHex = (array) => {
      return [...array].map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    const getCamoPublicKey = (privateKey) => {
      return bytesToHex(getCamoPublicKeyBytes(hexToBytes(privateKey)));
    }

    const getCamoPublicKeyBytes = (privateKeyBytes) => {
      const camoPrivateKeyBytes = nacl.camo.hashsecret(privateKeyBytes);
      const camoPublicKeyBytes = nacl.camo.scalarMult.base(camoPrivateKeyBytes);
      return camoPublicKeyBytes;
    }

    const getNewPrivateKey = () => {
      const private_key_elt = document.getElementById('private_key');
      const privateKey = new Uint8Array(32);
      window.crypto.getRandomValues(privateKey);
      const hex = bytesToHex(privateKey);
      // console.log('privateKey Set', hex.length, hex);
      private_key_elt.value = hex;
      return false;
    }

    const submitForm = () => {
      try {
        const private_key_elt = document.getElementById('private_key');
        const privateKey = private_key_elt.value;
        if (privateKey.length != 64) {
          alert(`bad secret key size ${privateKey.length} expecting ${64}`)
          return false;
        }

        // console.log('privateKey Get', privateKey.length, privateKey);
        const bananoPublicKey = getPublicKey(privateKey);
        const banano_account_elt = document.getElementById('banano_account');
        banano_account_elt.value = getAccount(bananoPublicKey);

        const camoPublicKey = getCamoPublicKey(privateKey);
        // console.log('camoPublicKey', camoPublicKey.length, camoPublicKey);
        const camo_account_elt = document.getElementById('camo_account');
        camo_account_elt.value = getAccount(camoPublicKey);
      } catch (error) {
        console.trace(error);
      }

      return false;
    }

    const getNewSharedSecret = () => {
      alert('not implemented yet');
      return false;
    }

    const onLoad = () => {

    }
  </script>
</body>

</html>
